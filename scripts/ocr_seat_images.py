#!/usr/bin/env python3
"""
ì¢Œì„ ë°°ì¹˜ ì´ë¯¸ì§€ë¥¼ OCRë¡œ ë¶„ì„í•˜ì—¬ JSONìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
"""

import json
import os
from pathlib import Path
from typing import List, Dict, Any
import re

# ìˆ˜ë™ìœ¼ë¡œ OCRëœ ë°ì´í„° (ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼)
MANUAL_OCR_DATA = [
    {
        "filename": "KakaoTalk_Photo_2025-11-15-00-01-53 001.jpeg",
        "date": "2025-11-09",
        "service": "2ë¶€ì˜ˆë°°",
        "anthem": "ë§Œêµ°ì˜ ì£¼ ì „ëŠ¥ì˜ ì™•",
        "offering_hymn_leader": "ì†Œì›",
        "total": 88,
        "breakdown": {"ì†Œí”„ë¼ë…¸": 30, "ì•Œí† ": 23, "í…Œë„ˆ": 14, "ë² ì´ìŠ¤": 15, "íŠ¹ì†¡": 6},
        "rows": [
            {"row": 1, "count": 10, "members": ["í™©ë´‰ì‹", "ê¹€í•™ì˜", "ì •í˜„ì„", "ìµœì°½ìš´", "ì´ìŠ¹ê· ", "ì„ì‚¼ì§„", "í•˜ë²”", "ê¹€íƒí›ˆ", "ì•ˆí˜•ì¤€", "10ëª…"]},
            {"row": 2, "count": 12, "members": ["ê³ ì—°ì£¼", "ê¹€ì§„í¬", "ì˜¤ì‹ ì˜", "ì •ì§„ë¬¸", "ê¹€í•œë¹›", "ìµœê´‘ì˜", "ì´ê·œë½", "ë°•ì¬ìš©", "ë¬¸ìŠ¹í˜„", "ì´ì›ì„­", "12ëª…"]},
            {"row": 3, "count": 14, "members": ["ê¹€ì •ìˆ™", "ì„ì‹ ì• ", "ì•¼ìŠ¹ìˆ™", "ì´ê°•ë´‰", "ì•ˆê°•í˜„", "ê¶Œì¸ì˜", "ê¹€ëŒ€ì˜", "ë‚¨ìŠ¹í˜¸", "ê¹€ì„±íœ˜", "ì•ˆìƒì€", "ê¹€ìˆ˜ì˜", "ì´ì€ì£¼", "ìµœìŠ¹ìš´", "14ëª…"]},
            {"row": 4, "count": 16, "members": ["í˜„ì„±í¬", "ë…¸ì€ìˆ™", "ì´ë¬¸í˜•", "ì´ìˆ˜ì§€", "ê¹€ì€í˜œ", "ì†ê¸°ìˆœ", "ë¬¸í¬", "ì˜¤ì—°ë¶„", "ê¹€í¬ì§„", "ë³€ì†Œì •", "ë°•ì„±í¬", "ë°±ì„±ì›", "ê¹€ìœ¤í¬", "ì´ìƒë¯¸", "ê¹€ìš´ì˜", "16ëª…"]},
            {"row": 5, "count": 15, "members": ["ê¹€ì§€í˜œ", "ì´ì¢…ìˆ™", "ì„í¬ì •", "ì´ì„ ë¯¸", "ì‹ ìˆ˜ì •", "ë°©ì§„ê²½", "ì´ì˜ë€", "ì´ìœ¤ì˜¥", "ìµœì—°í¬", "ì´ì§€ì˜", "ìµœìœ ì§„", "ì–‘ì•„ë¦„", "ê¹€ì˜ì •", "ìµœìœ ì§„", "15ëª…"]},
            {"row": 6, "count": 14, "members": ["ê¹€ì§€í˜œ", "ì¶”ë¯¼ì•„", "ê¹€ì†Œë¼", "ê¹€ë¬¸í¬", "ì„œí˜„ìˆ™", "ê¹€ì •í¬", "ê¹€í–¥ìˆ™", "ê¹€í˜œì„ ", "ì‹¬í¬ìˆ™", "ë¯¼ì€í™", "ê¹€ì†Œì˜¥", "ìµœëª…í¬", "ì´ê±´ì", "14ëª…"]}
        ]
    },
    {
        "filename": "KakaoTalk_Photo_2025-11-15-00-01-53 002.jpeg",
        "date": "2025-10-26",
        "service": "2ë¶€ì˜ˆë°°",
        "anthem": "ë‚´ ì£¼ëŠ” ê°•í•œ ì„±ì´ìš”",
        "offering_hymn_leader": "ê¹€ì§€í˜œ",
        "total": 84,
        "breakdown": {"ì†Œí”„ë¼ë…¸": 33, "ì•Œí† ": 22, "í…Œë„ˆ": 14, "ë² ì´ìŠ¤": 15},
        "rows": [
            {"row": 1, "count": 11, "members": ["í™©ë´‰ì‹", "ê¹€í•™ì˜", "ì •í˜„ì„", "ìµœì°½ìš´", "ì •ì§„ë¬¸", "ì´ìŠ¹ê· ", "ì„ì‚¼ì§„", "ì´ì² ì¬", "ê¹€ì² ìš°", "í•˜ë²”", "ì•ˆí˜•ì¤€"]},
            {"row": 2, "count": 13, "members": ["ê³ ì—°ì£¼", "ì„ì‹ ì• ", "ì˜¤ì‹ ì˜", "ê¹€í•œë¹›", "ë°°ì‚¬ë¬´ì—˜", "ë³€ì„±ì‹", "ìµœê´‘ì˜", "ê¹€ì°½ë™", "ì´ê·œë½", "ì´ê²½ì§„", "ë°•ì¬ìš©", "ë¬¸ìŠ¹í˜„", "ì´ì›ì„­"]},
            {"row": 3, "count": 15, "members": ["ê¹€ì •ìˆ™", "ì„ì‹ ì• ", "ë°±í•œë‚˜", "ì´ìŠ¹ìˆ™", "ì´ê°•ë´‰", "ì•ˆê°•í˜„", "ê¹€ì„±ëª©", "ê¶Œì¸ì˜", "ê¹€ëŒ€ì˜", "ë‚¨ìŠ¹í˜¸", "ì•ˆìƒì€", "ê¹€ì„±íœ˜", "ê¹€ìˆ˜ì˜", "ì´ì€ì£¼", "ìµœìŠ¹ìš´"]},
            {"row": 4, "count": 16, "members": ["í˜„ì„±í¬", "ì´ì„ ì•„", "ì‹ ë‚˜ë˜", "ì´ë¬¸í˜•", "ì´ìˆ˜ì§€", "ê¹€ì€í˜œ", "ì†ê¸°ìˆœ", "ë¬¸í¬", "ì˜¤ì—°ë¶„", "ìµœí•´ê²½", "ê¹€í¬ì§„", "ë³€ì†Œì •", "ë¯¼ê²½ì‹¤", "ì—¼ìš©ì£¼", "ì´ìƒë¯¸", "ê¹€ìš´í¬"]},
            {"row": 5, "count": 15, "members": ["ê¹€ì§€í˜œ", "ê¹€ì§€ì˜", "ì´ê´‘ìˆ™", "ì„í¬ì •", "ì´ì„ ë¯¸", "ì‹ ìˆ˜ì •", "ë°©ì§„ê²½", "ì´ì˜ë€", "ì´ìœ¤ì˜¥", "ì•ˆì€í¬", "ìµœì—°í¬", "ì´ì§€ì˜", "ìµœìœ ì§„", "ìµœìœ ì§„", "ê¹€ì€ì˜"]},
            {"row": 6, "count": 14, "members": ["ì´ì€í˜œ", "ì¶”ë¯¼ì•„", "ê¹€ì†Œë¼", "ê¹€ë¬¸í¬", "ì„œí˜„ìˆ™", "ê¹€ì •í¬", "ê¹€í–¥ìˆ™", "ê¹€í˜œì„ ", "ê°•í˜œì„ ", "ì‹¬í¬ìˆ™", "ë¯¼ì€í™", "ê¹€ì†Œì˜¥", "ìµœëª…í¬", "ì´ê±´ì"]}
        ]
    },
    {
        "filename": "KakaoTalk_Photo_2025-11-15-00-01-53 003.jpeg",
        "date": "2025-11-02",
        "service": "2ë¶€ì˜ˆë°°",
        "anthem": "ìƒˆ ë…¸ë˜ë¡œ ì°¬ì–‘í•˜ë¼",
        "offering_hymn_leader": "ì´ì›ì„­",
        "total": 80,
        "breakdown": {"ì†Œí”„ë¼ë…¸": 28, "ì•Œí† ": 23, "í…Œë„ˆ": 13, "ë² ì´ìŠ¤": 16},
        "rows": [
            {"row": 1, "count": 11, "members": ["í™©ë´‰ì‹", "ê¹€í•™ì˜", "ìµœì°½ìš´", "í™ì˜ì€", "ê¹€í•œë¹›", "ì´ìŠ¹ê· ", "ì„ì‚¼ì§„", "ì´ì² ì¬", "í•˜ë²”", "ê¹€íƒí›ˆ", "ì•ˆí˜•ì¤€"]},
            {"row": 2, "count": 12, "members": ["ê³ ì—°ì£¼", "ì˜¤ì‹ ì˜", "ê¹€ì§€ì˜", "ë°°ì‚¬ë¬´ì—˜", "ë³€ì„±ì‹", "ìµœê´‘ì˜", "ê¹€ì°½ë™", "ì´ê·œë½", "ë°•ì¬ìš©", "ê¹€ì² ìš°", "ë¬¸ìŠ¹í˜„", "ì´ì›ì„­"]},
            {"row": 3, "count": 14, "members": ["ë°±í•œë‚˜", "ì„ì‹ ì• ", "ì´ìŠ¹ìˆ™", "ì´ê°•ë´‰", "ì•ˆê°•í˜„", "ê¹€ì„±ëª©", "ê¶Œì¸ì˜", "ê¹€ëŒ€ì˜", "ë‚¨ìŠ¹í˜¸", "ì•ˆìƒì€", "ê¹€ì„±íœ˜", "ì´ê²½ì§„", "ê¹€ì€ì˜", "ìµœìŠ¹ìš´"]},
            {"row": 4, "count": 15, "members": ["í˜„ì„±í¬", "ì´ì„ ì•„", "ì´ìˆ˜ì§€", "ê¹€ì€í˜œ", "ì†ê¸°ìˆœ", "ë¬¸í¬", "ì˜¤ì—°ë¶„", "ìµœí•´ê²½", "ê¹€í¬ì§„", "ë³€ì†Œì •", "ì´ìƒë¯¸", "ë¯¼ê²½ì‹¤", "ì—¼ìš©ì£¼", "ê¹€ìˆ˜ì˜", "ì´ì€ì£¼"]},
            {"row": 5, "count": 14, "members": ["ê¹€ì§€í˜œ", "ë…¸ì€ìˆ™", "ì´ê´‘ìˆ™", "ì„í¬ì •", "ì‹ ìˆ˜ì •", "ë°©ì§„ê²½", "ì´ì˜ë€", "ì´ìœ¤ì˜¥", "ìµœì—°í¬", "ì´ì§€ì˜", "ë°±ì„±ì›", "ê¹€ì˜ì •", "ìµœìœ ì§„"]},
            {"row": 6, "count": 14, "members": ["ì´ì€í˜œ", "ì¶”ë¯¼ì•„", "ê¹€ì†Œë¼", "ê¹€ë¬¸í¬", "ì„œí˜„ìˆ™", "ê¹€í–¥ìˆ™", "ê¹€í˜œì„ ", "ê°•í˜œì„ ", "ì‹¬í¬ìˆ™", "ë¯¼ì€í™", "ê¹€ì†Œì˜¥", "ì•ˆì€í¬", "ìµœëª…í¬", "ì´ê±´ì"]}
        ]
    }
]


def convert_to_training_format(ocr_data: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """
    OCR ë°ì´í„°ë¥¼ ML í•™ìŠµìš© í¬ë§·ìœ¼ë¡œ ë³€í™˜
    """
    training_data = []

    for data in ocr_data:
        # ë©¤ë²„ë³„ íŒŒíŠ¸ ë§¤í•‘ í•„ìš” (ì‹¤ì œë¡œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
        # ì—¬ê¸°ì„œëŠ” í–‰ ë²ˆí˜¸ì™€ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ íŒŒíŠ¸ë¥¼ ì¶”ì •

        formatted_data = {
            "date": data["date"],
            "service": data["service"],
            "anthem": data.get("anthem", ""),
            "offering_hymn_leader": data.get("offering_hymn_leader", ""),
            "total": data["total"],
            "breakdown": data["breakdown"],
            "rows": []
        }

        for row_data in data["rows"]:
            # ë©¤ë²„ ì´ë¦„ì—ì„œ "Nëª…" ê°™ì€ ì¹´ìš´íŠ¸ ì œê±°
            members = [m for m in row_data["members"] if not re.match(r'\d+ëª…', m)]

            formatted_row = {
                "row": row_data["row"],
                "count": len(members),
                "members": members
            }
            formatted_data["rows"].append(formatted_row)

        training_data.append(formatted_data)

    return training_data


def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""

    # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
    output_dir = Path(__file__).parent.parent / "training_data"
    output_dir.mkdir(exist_ok=True)

    # OCR ë°ì´í„°ë¥¼ í•™ìŠµ í¬ë§·ìœ¼ë¡œ ë³€í™˜
    training_data = convert_to_training_format(MANUAL_OCR_DATA)

    # JSON íŒŒì¼ë¡œ ì €ì¥
    output_file = output_dir / "seat_arrangements_ocr.json"
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(training_data, f, ensure_ascii=False, indent=2)

    print(f"âœ… OCR ë°ì´í„° ë³€í™˜ ì™„ë£Œ: {output_file}")
    print(f"ğŸ“Š ì´ {len(training_data)}ê°œì˜ ë°°ì¹˜ íŒ¨í„´ì´ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.")

    # í†µê³„ ì¶œë ¥
    for i, data in enumerate(training_data, 1):
        print(f"\n[{i}] {data['date']} - {data['service']}")
        print(f"   ì´ì›: {data['total']}ëª…")
        print(f"   íŒŒíŠ¸ë³„: {data['breakdown']}")
        print(f"   í–‰ë³„ ì¸ì›: {[row['count'] for row in data['rows']]}")


if __name__ == "__main__":
    main()
